# تقرير وحدة الخدمات

## نظرة عامة
- تمثل الخدمات عروضًا يمكن نشرها في التطبيق مع دعم للدفع، والحقول المخصّصة، والتوجيه لمستخدم محدد. يعتمد النظام على نموذج `Service` لتعريف الحقول الأساسية وتوليد معرّف ثابت `service_uid` مع كل إنشاء وتطبيع قيم التحكم مثل الدفع والحقول المخصّصة قبل الحفظ.【F:app/Models/Service.php†L15-L155】
- ترتبط الخدمة بفئات، ومالكين، ومستخدمين محددين للدردشة، إضافةً إلى علاقات مع الحقول المخصّصة، الطلبات، والمراجعات لضمان دورة حياة متكاملة للمنتج الرقمي.【F:app/Models/Service.php†L317-L389】

## نموذج البيانات الأساسي
### نموذج Service
- الحقول القابلة للتعبئة تغطي البيانات الأساسية (العنوان، الوصف، الصور) بالإضافة إلى إعدادات التدفق مثل حالة الدفع، التوجيه المباشر، ومخطط الحقول المخصّصة المخزّن كـ JSON.【F:app/Models/Service.php†L40-L74】
- يعتمد النموذج على `casts` لضمان أنواع منطقية (booleans للأعلام، arrays للوسوم والمخطط) مع تنظيف تلقائي للسعر والعملة ومعرّف المستخدم الموجّه عندما تكون الخيارات المعنية معطّلة.【F:app/Models/Service.php†L79-L149】
- يقدّم Accessor موحّدًا لـ `service_fields_schema` يعيد مصفوفة منظّمة بسبعة أنواع مدعومة ويستطيع التحوّل إلى الحقول المرتبطة إذا كانت المخططات مخزّنة في الجداول المادية فقط.【F:app/Models/Service.php†L161-L276】

### الحقول المخصّصة المرتبطة
- يوفّر نموذج `ServiceCustomField` تعريفًا غنيًا للحقول (نوع الحقل، الخيارات، القيم الدنيا/العليا، الأيقونات) مع توليد مفتاح نموذج موحّد يمكن استرجاعه في الواجهات المختلفة.【F:app/Models/ServiceCustomField.php†L10-L191】
- تقوم الدالة `toSchemaPayload` بتحويل الحقل المادي إلى تمثيل JSON متجانس يُستخدم في واجهة الإدارة والتطبيق على حدٍ سواء.【F:app/Models/ServiceCustomField.php†L151-L191】

## إدارة الخدمات في لوحة التحكم
- يقيّد `ServiceController` الفئات المتاحة ويحمّل القوائم الأولية للإدخال قبل عرض نموذج الإنشاء، مع احترام أذونات المستخدمين عبر `ServiceAuthorizationService`. يتم تمرير قوائم العملاء لكلٍ من المالك والمستخدم الموجّه.【F:app/Http/Controllers/ServiceController.php†L540-L553】【F:app/Http/Controllers/ServiceController.php†L892-L897】
- أثناء الحفظ (`store`/`update`) يتم التحقق من صحة الحقول الأساسية، إعدادات الدفع، التوجيه، والسكيمة المخصّصة؛ كما تُطبع الأعلام المنطقية وتُصفّر الحقول التابعة تلقائيًا عند تعطيل الخيارات ذات العلاقة.【F:app/Http/Controllers/ServiceController.php†L558-L757】
- يرفع المتحكم صور الخدمة والأيقونة إلى قرص `public` داخل مجلد `services_images` مع حذف النسخة القديمة عند الاستبدال، ويعيد المسار النسبي للتخزين في قاعدة البيانات.【F:app/Http/Controllers/ServiceController.php†L900-L920】
- بعد نجاح الحفظ تتم مزامنة السكيمة مع جدول `service_custom_fields` بما في ذلك إدارة الأيقونات، إعادة بناء البيانات التعريفية، وتحديث نسخة السكيمة المخزّنة في النموذج لضمان انسجام الواجهات وواجهات البرمجة.【F:app/Http/Controllers/ServiceController.php†L1430-L1698】

## الحقول المخصّصة وتجربة العميل
- يستخدم `ServiceCustomFieldSubmissionService` السكيمة المرفقة بالخدمة أو الحقول المادية لبناء تعريفات الحقول، ثم يطبّع المدخلات الآتية من التطبيق (القيم والملفات) ويربطها بالأسماء المستعارة لكل حقل.【F:app/Services/ServiceCustomFieldSubmissionService.php†L18-L282】
- يتم إنشاء قواعد تحقق ديناميكية حسب نوع الحقل (نصي، رقم، قائمة، ملفات) بما في ذلك الحدود الدنيا والعليا والخيارات المسموح بها، ويُعاد بناء الحمولة النهائية بصيغة موحّدة تتضمن مسارات الملفات المرفوعة على التخزين العام عند الحاجة.【F:app/Services/ServiceCustomFieldSubmissionService.php†L377-L568】

## إدارة طلبات الخدمات
### واجهة برمجة التطبيقات
- يتيح `Api\ServiceRequestController` للمستخدم استعراض طلباته مع فلاتر الحالة والفئة، ويُلزم المصادقة قبل الإرجاع.【F:app/Http/Controllers/Api/ServiceRequestController.php†L28-L76】
- عند إنشاء طلب جديد يتم التحقق من توافر الخدمة وحالتها، احترام التوجيه المباشر، والتحقق من إتمام الدفع الناجح للخدمات المدفوعة عبر جدول المعاملات قبل قبول الطلب.【F:app/Http/Controllers/Api/ServiceRequestController.php†L80-L142】
- يجمع المتحكم قيم الحقول المخصّصة وملفاتها عبر خدمة التجميع، ويحفظ الطلب بحالة `review`، ثم يرسل إشعار FCM للمستخدم مع رابط عميق لمتابعة الطلب داخل التطبيق.【F:app/Http/Controllers/Api/ServiceRequestController.php†L145-L247】

### لوحة الإدارة
- يقدّم `ServiceRequestController` (لوحة التحكم) شاشة موحّدة تعرض الطلبات مع فلاتر للفئات والحالة وبحث نصي، إضافة إلى أزرار عرض، تحديث حالة، وحذف وفق الأذونات الممنوحة.【F:app/Http/Controllers/ServiceRequestController.php†L17-L200】

## مراجعات الخدمات
- يتيح `ServiceReviewController` للمسؤول استعراض مراجعات الخدمة مع فلتر الحالة، كما يمكنه تحديث الحالة إلى معتمد أو مرفوض بعد التحقق من الصلاحيات وتطابق الخدمة المستهدفة.【F:app/Http/Controllers/ServiceReviewController.php†L14-L85】

## الأذونات والتحكم بالوصول
- يحدد `ServiceAuthorizationService` أدوار الإدارة الكاملة ويقيّد الاستعلامات بحيث لا يرى المستخدم إلا الخدمات أو الفئات التي يديرها، كما يوفر وسائل مساعدة للتحقق من صلاحية إدارة خدمة أو فئة بعينها في جميع المتحكمات المتعلقة بالخدمات والطلبات والمراجعات.【F:app/Services/ServiceAuthorizationService.php†L10-L148】

## نقاط تكامل إضافية
- يحافظ متحكم الخدمات على اتساق قيم الحقول المخصّصة المخزّنة عبر `syncServiceCustomFieldValues` لضمان توفر القيم الأولية في واجهات التحرير والاستيراد المتكرر، مع استخدام `ServiceCustomFieldValue::upsert` لتحديث السجلات بكفاءة.【F:app/Http/Controllers/ServiceController.php†L1400-L1422】
- يتم تنظيف الأيقونات المرفوعة للحقول المخصّصة واستبدالها عبر `FileService` لضمان عدم تراكم ملفات غير مستخدمة بعد التعديلات المتكررة على السكيمة.【F:app/Http/Controllers/ServiceController.php†L1512-L1645】
- يوفر النظام تدفق إشعارات فورية للمستخدمين عند إنشاء الطلبات عبر FCM، ما يدعم تجربة متابعة في التطبيق دون الحاجة إلى التحقق اليدوي المستمر.【F:app/Http/Controllers/Api/ServiceRequestController.php†L196-L231】

## فرق إدارة الخدمات (المدراء والفرق التشغيلية)
- يتم تعريف الفرق كمجموعة من العملاء المصرّح لهم بإدارة فئات محددة عبر جدول محوري `category_managers` الذي يربط كل فئة بعدة مدراء مع ضمان عدم تكرار السجلات.【F:database/migrations/2024_05_30_000000_create_service_managers_table.php†L14-L29】
- يتيح `CategoryManagerController` للمسؤولين إضافة أو إزالة المدراء من كل فئة بعد التحقق من الصلاحيات، ويعيد شاشة إعداد تعرض المدراء الحاليين وقائمة العملاء المتاحين للاختيار.【F:app/Http/Controllers/CategoryManagerController.php†L14-L43】
- عند الحفظ تتم مزامنة قائمة المدراء مع الجدول المحوري بعد التحقق من أن كل معرف يعود لعميل صالح، مع إعادة التوجيه بنجاح بعد التحديث.【F:app/Http/Controllers/CategoryManagerController.php†L46-L79】
- يعتمد النظام على `ServiceAuthorizationService` لتقييد استعلامات الخدمات والطلبات بحيث لا يرى المدير سوى الفئات أو الخدمات الموكلة إليه، كما يوفّر وسائل تحقق تُستخدم في كل من الوسطاء ومتحكمات الإدارة والتطبيق.【F:app/Services/ServiceAuthorizationService.php†L12-L149】

## التعليقات والملاحظات التشغيلية
- تمثل مراجعات الخدمات قناة التعليقات العامة، إذ يحفظ نموذج `ServiceReview` التقييم والنص مع حالات `pending/approved/rejected` ما يتيح للمسؤول تصفية المراجعات ومعالجتها لاحقًا.【F:app/Models/ServiceReview.php†L9-L51】
- يوفر `ServiceReviewController` واجهة إدارية لاستعراض المراجعات مع بيانات كاتبها وتعديل حالتها بعد التحقق من صلاحية المدير المسؤول عن الخدمة.【F:app/Http/Controllers/ServiceReviewController.php†L20-L85】
- يدعم طلب الخدمة ملاحظات داخلية عبر حقل `note` الذي يتم التحقق منه وتخزينه ضمن حمولة الطلب وإرجاعه في استجابات API، إضافة إلى تسجيل سبب الرفض عند تغيير الحالة لضمان تتبع القرار مع المستخدم.【F:app/Http/Controllers/Api/ServiceRequestController.php†L82-L213】【F:app/Http/Controllers/Api/ServiceRequestController.php†L249-L269】【F:app/Http/Controllers/ServiceRequestController.php†L225-L308】

## نظام البلاغات على مراجعات الخدمات
- يعالج نموذج `ServiceReviewReport` بلاغات المستخدمين على التعليقات، مع ربط البلاغ بالمراجعة وصاحبه وتوليد إشعار إداري يحتوي على بيانات الخدمة والمبلّغ وحالة المعالجة.【F:app/Models/ServiceReviewReport.php†L13-L70】
- يتيح طرفية `addServiceReviewReport` في `ApiController` تقديم البلاغات بعد التحقق من صحة المدخلات ومنع الإبلاغ المكرر أو الذاتي، ثم حفظ البلاغ بحالة `pending` وإرجاع معرفه للمستخدم.【F:app/Http/Controllers/ApiController.php†L4860-L4917】

## مالك الخدمة وامتيازات المتابعة
- يدعم نموذج الخدمة علاقة `owner` لربط كل خدمة بمالكها من العملاء، كما تتيح نماذج الإنشاء والتعديل في لوحة التحكم اختيار المالك والتحقق من صلاحيته وتخزين معرّفه ضمن بيانات الخدمة.【F:app/Models/Service.php†L40-L96】【F:app/Models/Service.php†L320-L349】【F:app/Http/Controllers/ServiceController.php†L562-L648】【F:app/Http/Controllers/ServiceController.php†L702-L780】
- عند نشر مراجعة جديدة يتم إخطار مالك الخدمة عبر FCM وتسجيل إشعار داخلي يتضمن تفاصيل المراجعة والتقييم لتعزيز المتابعة اللحظية من قبل المالك.【F:app/Http/Controllers/ApiController.php†L4942-L5027】
- توفر واجهات الـAPI للمالكين القدرة على استعراض خدماتهم، وتحديث حالة الخدمة أو تاريخ انتهائها، أو حذفها بالكامل بعد التحقق من ملكيتهم وتحديث البيانات المرتبطة مثل الحقول المخصّصة والوسائط.【F:app/Http/Controllers/ApiController.php†L5221-L5321】

## تتبع انتهاء الخدمة وتفعيلها
- يحتوي نموذج الخدمة على حقل `expiry_date` إضافة إلى العلم `status` لتحديد ما إذا كانت الخدمة نشطة، ويتم التحقق من صحة هذه القيم وتطبيعها في عمليات الإنشاء والتعديل من لوحة التحكم مع دعم اختيار المالك وإدارة التدفق.【F:app/Http/Controllers/ServiceController.php†L562-L648】【F:app/Http/Controllers/ServiceController.php†L702-L780】
- تُخفي واجهات التطبيق الخدمات غير النشطة أو المنتهية تلقائيًا عبر فلاتر API التي تشترط أن يكون `status` مفعّلًا وأن يكون تاريخ الانتهاء خاليًا أو مستقبليًا سواء في استعلام خدمة مفردة أو قائمة خدمات.【F:app/Http/Controllers/ApiController.php†L5346-L5438】
- تتيح واجهات المالك تحديث حالة الخدمة أو تاريخ انتهائها بصورة مباشرة، ما يمكّنه من إيقاف الخدمة مؤقتًا أو تمديد صلاحيتها دون تدخل فريق الدعم.【F:app/Http/Controllers/ApiController.php†L5245-L5291】