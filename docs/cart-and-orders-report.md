# تقرير تفصيلي حول السلة وآلية الشراء وإدارة الطلبات

## 1. نظرة عامة
يوفر هذا التقرير وصفًا متكاملًا لدورة حياة السلة (Cart) منذ لحظة إضافة العناصر وحتى إتمام الطلب، مع تغطية آليات التسعير والشحن، وتحصيل المدفوعات، وإدارة الطلبات بعد إنشائها. يعتمد الشرح على الشفرة المصدرية الحالية للتطبيق، ويستهدف فرق المنتج، والتطوير، والدعم الفني لفهم التدفقات والقيود والبيانات التي يتم تبادلها عبر الواجهات البرمجية.

## 2. نماذج البيانات الأساسية
- **CartItem**: يمثل عنصرًا داخل سلة مستخدم محدد، ويحفظ معلومات السعر، الكمية، العملة، السمات، والصور المفصلة للمخزون. يتم تحويل الحقول الحساسة مثل الكمية والسعر إلى أنواع رقمية، ويتم احتساب `subtotal` ديناميكيًا اعتمادًا على السعر المقفل. 【F:app/Models/CartItem.php†L9-L42】
- **CartCouponSelection**: يحتفظ بالقسيمة التي اختارها المستخدم للسلة، بما في ذلك القسم المرتبط وتاريخ التطبيق. تُخزن البيانات الوصفية بصيغة JSON لدعم التحليلات اللاحقة. 【F:app/Models/CartCouponSelection.php†L9-L34】
- **Order**: يجسد الطلب بعد تأكيد الشراء ويحتفظ بسنابشوت كامل لحالة السلة، أسعار الشحن، المدفوعات، سجلات الحالة، وسياسات العربون. يدعم النموذج تواريخ متعددة، وحالات دفع مختلفة، وحقول ملحقة تلخص المدفوعات والتتبع. 【F:app/Models/Order.php†L18-L136】
- **OrderItem**: يسجل العناصر المنقولة من السلة إلى الطلب مع نسخ للسعر والسمات وسياسات العربون، ما يسمح بتحليل لاحق للحالة الفعلية للمنتج وقت الشراء. 【F:app/Models/OrderItem.php†L9-L84】

## 3. واجهات السلة (Cart API)
### 3.1 جلب السلة وتسجيل التتبع
استدعاء `GET /api/cart` يجمع عناصر السلة الحالية للمستخدم، ويرسل حدث Telemetry `cart.view_cart`، ويعيد الاستجابة عبر `buildResponse` مع إمكانية تضمين بيانات إتمام الشراء حسب الطلب. 【F:app/Http/Controllers/CartController.php†L47-L56】

### 3.2 إضافة عنصر أو تحديثه
- تستخدم `POST /api/cart/items` (وأسماء مستعارة إضافية) التابع `store` للتحقق من صحة البيانات، وحسم القسم المناسب تلقائيًا اعتمادًا على المدخلات أو تصنيف العنصر. تُفرض قاعدة «قسم واحد فقط لكل سلة»، ويتم التحقق من عدم التعارض في العملات قبل حفظ العنصر. 【F:app/Http/Controllers/CartController.php†L59-L205】
- عند تحديث الكميات (`PATCH /api/cart/items/{id}`) تُعاد عمليات التحقق نفسها للعملة والتعارض في المتغيرات، ويتم تحديث السمات واللقطات المخزنية عند الحاجة. 【F:app/Http/Controllers/CartController.php†L207-L275】

### 3.3 حذف العناصر وإفراغ السلة
- `DELETE /api/cart/items/{id}` يزيل عنصرًا محددًا ويعيد بناء الاستجابة مع مسح ذاكرة التخزين المؤقت لعروض الشحن. 【F:app/Http/Controllers/CartController.php†L290-L319】
- `DELETE /api/cart/clear` يقبل قسمًا اختياريًا لمسح جزء من السلة مع إعادة التحقق من القسم. 【F:app/Http/Controllers/CartController.php†L320-L366】

### 3.4 إدارة القسائم والخصومات
- `POST /api/cart/apply-coupon` (ومكافئاته) تحفظ اختيار القسيمة في `CartCouponSelection` بعد التأكد من صلاحيتها. وعند حساب معلومات الدفع يتم تقييم حالة القسيمة (مفعلة، تخطت الحد، إلخ) مع إرجاع تفاصيل الخصم. 【F:app/Http/Controllers/CartController.php†L483-L1015】

### 3.5 معلومات إتمام الشراء الفورية
- `GET /api/checkout-info` يبني ملخصًا مركبًا يحتوي على العناصر، الإجمالي، الخصومات، عملة السلة، ومؤشر تضارب العملات. يتم توليد `ETag` لتقليل استهلاك الشبكة عند عدم تغير البيانات. 【F:app/Http/Controllers/CartController.php†L896-L959】

### 3.6 ضبط قسم السلة والعملات
- تعتمد الدوال المساندة `resolveDepartment` و`normalizeDepartment` على تكوينات النظام لتوحيد أسماء الأقسام واكتشاف القسم الافتراضي أو القسم المستنتج من التصنيف. 【F:app/Http/Controllers/CartController.php†L1049-L1213】
- تبقي `userCartItems` الاستعلامات موحدة مع تحميل جزئي للمعلومات الضرورية عن المنتج. 【F:app/Http/Controllers/CartController.php†L1270-L1278】

## 4. تسعير الشحن وإدارة العربون
### 4.1 خدمة عروض الشحن
خدمة `CartShippingQuoteService` هي محور حساب تكلفة التوصيل. تتحقق من وجود عناصر وعنوان صالح مع إحداثيات، ثم تقرأ سياسة التسعير، وتحسب إجمالي السلة والوزن، وتستخدم التخزين المؤقت لنتائج التسعير لمدة عشر دقائق قابلة للإجبار على التحديث. 【F:app/Services/CartShippingQuoteService.php†L26-L166】

### 4.2 خيارات التوصيل والعربون
عند احتساب التسعير، يتم تمرير تفضيل توقيت الدفع (نقدًا الآن أو عند الاستلام) وخيار تمكين العربون. تتبع الخدمة سياسة التسعير النشطة وتعيد تفاصيل تشمل السعر النهائي، الرسوم، وسياسة العربون لكل عنصر إذا كانت مفعلة. 【F:app/Services/CartShippingQuoteService.php†L183-L200】【F:app/Services/OrderCheckoutService.php†L113-L168】

## 5. تدفق إتمام الشراء (Checkout)
### 5.1 التحقق وتجهيز البيانات
خدمة `OrderCheckoutService::checkout` تعمل داخل معاملة قاعدة البيانات. تبدأ بتحميل عناصر السلة، التأكد من توافر المخزون ومطابقة الأسعار المقفلة، والتحقق من عدم وجود تضارب عملات. كما تسترجع التوقيت المفضل للدفع وتبني خيارات طلب عرض شحن جديد عند الحاجة. 【F:app/Services/OrderCheckoutService.php†L79-L139】

### 5.2 حساب التكاليف والخصومات
بعد الحصول على عرض الشحن، يتم حساب إجمالي البضائع، الضرائب، الخصومات الناتجة عن القسائم، والتوصيل. ثم تُبنى لقطة كاملة لخيارات الدفع (التسليم الآن/عند الاستلام)، وتُخزن لتتبع التفضيلات المستقبلية. 【F:app/Services/OrderCheckoutService.php†L140-L183】

### 5.3 إنشاء الطلب وسنابشوت البيانات
- يتم إنشاء سجل `Order` مع رقم طلب مؤقت ورقم فاتورة، وحفظ جميع الحقول المحسوبة بما في ذلك تفاصيل الشحن، العربون، ملخص الحالة، ولقطات الأسعار. 【F:app/Services/OrderCheckoutService.php†L221-L288】
- تُحوَّل كل عناصر السلة إلى `OrderItem` مع نسخ كاملة للسمات والوزن وسياسة العربون الخاصة بكل عنصر. 【F:app/Services/OrderCheckoutService.php†L305-L353】
- يُسجل تاريخ الطلب (`OrderHistory`) ويتم إرسال أحداث Telemetry `checkout.begin_checkout` و`checkout.purchase` لمتابعة الأداء. 【F:app/Services/OrderCheckoutService.php†L190-L369】
- بعد إتمام العملية يتم تفريغ السلة ومسح ذاكرة عروض الشحن لضمان اتساق الحالة. 【F:app/Services/OrderCheckoutService.php†L365-L374】

## 6. واجهات إدارة الطلبات
### 6.1 إنشاء الطلب عبر API
واجهة `POST /api/orders` تتحقق من صحة البيانات (العنوان، القسم، الضرائب، توقيت الدفع، إلخ)، وتدعم رأس `Idempotency-Key` لمنع التكرار. عند النجاح تُعاد استجابة تتضمن الطلب، نية الدفع الافتراضية، وسياسات القسم والدعم. في حال إرسال مفتاح مستخدم سابقًا، تُعاد تفاصيل الطلب السابق بعد التحقق من ملكية المستخدم. 【F:app/Http/Controllers/OrderApiController.php†L79-L213】

### 6.2 استرجاع الطلبات ومشاهدة التفاصيل
- `GET /api/orders` يدعم الترشيح حسب الحالة والصفحات، مع إرفاق حقول مساعدة (`status_display`, `actions`). 【F:app/Http/Controllers/OrderApiController.php†L47-L77】
- `GET /api/orders/{id}` يجلب الطلب مع العلاقات المرتبطة (العناصر، البائع، القسيمة، التاريخ، المدفوعات) ويعيد نفس ملحقات المساعدة مع بيانات الدعم. 【F:app/Http/Controllers/OrderApiController.php†L217-L246】

### 6.3 إلغاء الطلب وجمع مبالغ التوصيل
- `POST /api/orders/{id}/cancel` يتحقق من إمكانية الإلغاء قبل استدعاء `OrderCancellationService` وتسجيل النتيجة. 【F:app/Http/Controllers/OrderApiController.php†L250-L275】
- `POST /api/orders/{id}/collect-delivery` يسمح بتسجيل المبالغ المحصلة عند التسليم، ويحافظ على دقة الرصيد المتبقي عبر تحديث `payment_payload` وإضافة مدخل إلى تاريخ الطلب عند وجود ملاحظة. 【F:app/Http/Controllers/OrderApiController.php†L279-L377】

### 6.4 دعم التتبع والمدفوعات
جميع الاستجابات المتعلقة بالطلب تتضمن `payment_intent` المبني عبر `OrderPaymentService`، بالإضافة إلى سياسات القسم والدعم لتوفير تجربة متكاملة للعميل بعد الشراء. 【F:app/Http/Controllers/OrderApiController.php†L149-L213】【F:app/Http/Controllers/OrderApiController.php†L237-L274】

## 7. توصيات تشغيلية
1. **مراقبة التوافق بين القسم والعناصر**: نظراً لاعتماد السلة على قسم موحد، يجب تحديث إعدادات الأقسام (`config/cart.php`) بالتزامن مع أي توسعات في فئات المنتجات لضمان تمرير التحقق. 【F:app/Http/Controllers/CartController.php†L95-L125】【F:app/Http/Controllers/CartController.php†L1049-L1250】
2. **التعامل مع العملات المتعددة**: في حال توسيع المنصة لدعم عملات إضافية، يلزم تحديث منطق التطبيع ومنع التعارضات لضمان تجربة مستخدم سلسة. 【F:app/Http/Controllers/CartController.php†L130-L171】【F:app/Services/OrderCheckoutService.php†L97-L111】
3. **تحسين التخزين المؤقت لعروض الشحن**: يمكن ضبط مدة التخزين أو استراتيجية المفاتيح في `CartShippingQuoteService` بحسب حجم حركة المرور وتكرار تحديث السياسات. 【F:app/Services/CartShippingQuoteService.php†L26-L166】
4. **متابعة أحداث Telemetry**: الأحداث المسجلة أثناء العرض والشراء تساعد في رصد المشاكل مبكرًا؛ يُنصح بتكاملها مع لوحة مراقبة فورية. 【F:app/Http/Controllers/CartController.php†L50-L55】【F:app/Services/OrderCheckoutService.php†L190-L369】【F:app/Http/Controllers/OrderApiController.php†L349-L358】